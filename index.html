<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Mappa delle fontane e beverini di Napoli - PWA">
    <meta name="keywords" content="fontane, beverini, napoli, acqua, mappa">
    <meta name="author" content="Comune di Napoli">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fontane Napoli">
    <link rel="apple-touch-icon" href="images/icona-avvio.png">
    <link rel="apple-touch-startup-image" href="images/icona-avvio-splash.png">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="images/icona-avvio.png" type="image/png">
    
    <title>Fontane & Beverini Napoli</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvDfxm-LSAcu0NwtJ8DYxxrjY-83LlLPU",
            authDomain: "abcnapolifontane.firebaseapp.com",
            projectId: "abcnapolifontane",
            storageBucket: "abcnapolifontane.firebasestorage.app",
            messagingSenderId: "686936372148",
            appId: "1:686936372148:web:4147bab1bab73583b638e1"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        
        console.log("Firebase inizializzato correttamente");
        
        // Controlla stato autenticazione
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Admin autenticato:", user.email);
                window.isAdmin = true;
            } else {
                console.log("Nessun admin autenticato");
                window.isAdmin = false;
            }
        });
    </script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Caricamento in corso...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-header">
        <div class="header-content">
            <div class="logo-container">
                <img src="images/logo-comune.png" alt="Comune di Napoli" class="logo-comune" id="main-logo">
                <div class="app-title">
                    <h1>Fontane & Beverini</h1>
                    <p>Comune di Napoli</p>
                </div>
            </div>
            <div class="header-actions">
                <button id="search-toggle" class="icon-btn" title="Cerca">
                    <span>üîç</span>
                </button>
                <button id="filter-toggle" class="icon-btn" title="Filtri">
                    <span>‚öôÔ∏è</span>
                </button>
                <button id="refresh-btn" class="icon-btn" title="Aggiorna">
                    <span>üîÑ</span>
                </button>
            </div>
        </div>
        
        <!-- Barra di ricerca -->
        <div id="search-bar" class="search-bar hidden">
            <input type="text" id="search-input" placeholder="Cerca per indirizzo o nome...">
            <button id="search-clear" class="clear-btn">‚úï</button>
        </div>
        
        <!-- Filtri -->
        <div id="filter-panel" class="filter-panel hidden">
            <div class="filter-section">
                <h3>Stato Fontane</h3>
                <div class="filter-options">
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filter-working" checked>
                        <span class="checkmark"></span>
                        <span class="status-indicator working"></span>
                        Funzionanti
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filter-not-working" checked>
                        <span class="checkmark"></span>
                        <span class="status-indicator not-working"></span>
                        Non funzionanti
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filter-maintenance" checked>
                        <span class="checkmark"></span>
                        <span class="status-indicator maintenance"></span>
                        In manutenzione
                    </label>
                </div>
            </div>
            <div class="filter-section">
                <h3>Tipo</h3>
                <div class="filter-options">
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filter-fountains" checked>
                        <span class="checkmark"></span>
                        Fontane
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" id="filter-drinking" checked>
                        <span class="checkmark"></span>
                        Beverini
                    </label>
                </div>
            </div>
            <button id="apply-filters" class="apply-btn">Applica Filtri</button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Home Screen -->
        <section id="home-screen" class="screen active">
            <div class="hero-section">
                <div class="hero-image">
                    <img src="images/sfondo-home.jpg" alt="Fontane di Napoli">
                    <div class="hero-overlay">
                        <h2>Acqua Pubblica Napoli</h2>
                        <p>Trova le fontane e i beverini nella tua citt√†</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card glass-card">
                    <div class="stat-icon">‚õ≤</div>
                    <h3>Fontane</h3>
                    <p id="total-fountains">0</p>
                    <small>Totale registrate</small>
                </div>
                <div class="stat-card glass-card">
                    <div class="stat-icon">üö∞</div>
                    <h3>Beverini</h3>
                    <p id="total-drinking">0</p>
                    <small>Totale registrati</small>
                </div>
                <div class="stat-card glass-card">
                    <div class="stat-icon">‚úÖ</div>
                    <h3>Funzionanti</h3>
                    <p id="total-working">0</p>
                    <small>Attualmente attivi</small>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="action-btn" data-target="fontane">
                    <span class="action-icon">‚õ≤</span>
                    <span>Fontane</span>
                </button>
                <button class="action-btn" data-target="beverini">
                    <span class="action-icon">üö∞</span>
                    <span>Beverini</span>
                </button>
                <button class="action-btn" data-target="mappa">
                    <span class="action-icon">üó∫Ô∏è</span>
                    <span>Mappa</span>
                </button>
                <button class="action-btn" data-target="news">
                    <span class="action-icon">üì∞</span>
                    <span>News</span>
                </button>
            </div>
            
            <div class="recent-news glass-card">
                <h3>Ultime News</h3>
                <div id="news-list" class="news-list">
                    <!-- News caricate dinamicamente -->
                </div>
            </div>
        </section>

        <!-- Fontane Screen -->
        <section id="fontane-screen" class="screen">
            <div class="screen-header">
                <h2>Fontane di Napoli</h2>
                <div class="screen-controls">
                    <button id="add-fountain-btn" class="add-btn hidden" title="Aggiungi fontana">
                        <span>+</span>
                    </button>
                </div>
            </div>
            <div class="list-container" id="fontane-list">
                <!-- Lista fontane -->
            </div>
        </section>

        <!-- Beverini Screen -->
        <section id="beverini-screen" class="screen">
            <div class="screen-header">
                <h2>Beverini di Napoli</h2>
                <div class="screen-controls">
                    <button id="add-drinking-btn" class="add-btn hidden" title="Aggiungi beverino">
                        <span>+</span>
                    </button>
                </div>
            </div>
            <div class="list-container" id="beverini-list">
                <!-- Lista beverini -->
            </div>
        </section>

        <!-- Mappa Screen -->
        <section id="mappa-screen" class="screen">
            <div class="screen-header">
                <h2>Mappa</h2>
                <div class="screen-controls">
                    <button id="locate-btn" class="icon-btn" title="La mia posizione">
                        <span>üìç</span>
                    </button>
                    <button id="map-type-btn" class="icon-btn" title="Cambia mappa">
                        <span>üó∫Ô∏è</span>
                    </button>
                </div>
            </div>
            <div id="map-container"></div>
            <div class="map-legend glass-card">
                <div class="legend-item">
                    <span class="legend-color working"></span>
                    <span>Funzionante</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color not-working"></span>
                    <span>Non funzionante</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color maintenance"></span>
                    <span>Manutenzione</span>
                </div>
            </div>
        </section>

        <!-- News Screen -->
        <section id="news-screen" class="screen">
            <div class="screen-header">
                <h2>News & Aggiornamenti</h2>
                <div class="screen-controls">
                    <button id="add-news-btn" class="add-btn hidden" title="Aggiungi news">
                        <span>+</span>
                    </button>
                </div>
            </div>
            <div class="news-container" id="news-container">
                <!-- Lista completa news -->
            </div>
        </section>
    </main>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="modal hidden">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h3>Accesso Amministratore</h3>
                <button id="close-admin" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="admin-login">
                    <input type="email" id="admin-email" placeholder="Email" required>
                    <input type="password" id="admin-password" placeholder="Password" required>
                    <button id="admin-login-btn" class="primary-btn">Accedi</button>
                    <p id="admin-error" class="error-message"></p>
                </div>
                <div id="admin-panel" class="hidden">
                    <div class="admin-section">
                        <h4>Gestione Dati</h4>
                        <button id="sync-data" class="admin-btn">Sincronizza con Firebase</button>
                        <button id="export-data" class="admin-btn">Esporta Excel</button>
                        <button id="import-data" class="admin-btn">Importa Excel</button>
                        <button id="backup-data" class="admin-btn">Backup Locale</button>
                    </div>
                    <div class="admin-section">
                        <h4>Statistiche</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>Fontane:</span>
                                <span id="admin-fountains">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Beverini:</span>
                                <span id="admin-drinking">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Utenti Online:</span>
                                <span id="admin-users">1</span>
                            </div>
                        </div>
                    </div>
                    <div class="admin-section">
                        <button id="admin-logout" class="logout-btn">Esci</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="bottom-nav glass-nav">
        <button class="nav-btn active" data-target="home">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-btn" data-target="fontane">
            <span class="nav-icon">‚õ≤</span>
            <span class="nav-label">Fontane</span>
        </button>
        <button class="nav-btn" data-target="beverini">
            <span class="nav-icon">üö∞</span>
            <span class="nav-label">Beverini</span>
        </button>
        <button class="nav-btn" data-target="mappa">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-label">Mappa</span>
        </button>
        <button class="nav-btn" data-target="news">
            <span class="nav-icon">üì∞</span>
            <span class="nav-label">News</span>
        </button>
    </nav>

    <!-- Modale per dettagli -->
    <div id="detail-modal" class="modal hidden">
        <div class="modal-content glass-card detail-modal">
            <div class="modal-header">
                <h3 id="detail-title"></h3>
                <button id="close-detail" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body" id="detail-body">
                <!-- Dettagli caricati dinamicamente -->
            </div>
            <div class="modal-footer">
                <button id="navigate-btn" class="primary-btn">Naviga</button>
                <button id="report-btn" class="secondary-btn">Segnala</button>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="install-prompt" class="install-prompt glass-card hidden">
        <div class="prompt-content">
            <p>Installa l'app per un'esperienza migliore!</p>
            <div class="prompt-buttons">
                <button id="install-btn" class="primary-btn">Installa</button>
                <button id="dismiss-install" class="secondary-btn">Pi√π tardi</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Registra Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrato:', reg))
                    .catch(err => console.log('Service Worker errore:', err));
            });
        }
        
        // Gestione installazione PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('install-prompt').classList.remove('hidden');
            }, 3000);
        });
        
        document.getElementById('install-btn').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Utente ha installato la PWA');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-prompt').classList.add('hidden');
                });
            }
        });
        
        document.getElementById('dismiss-install').addEventListener('click', () => {
            document.getElementById('install-prompt').classList.add('hidden');
        });
    </script>
</body>
</html>