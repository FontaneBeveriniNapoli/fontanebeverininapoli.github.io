<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mappa delle fontane e beverini di Napoli">
    <meta name="theme-color" content="#007bff">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="images/icona-avvio.png">
    <link rel="apple-touch-startup-image" href="images/icona-avvio-splash.png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="stylesheet" href="style.css">
    <title>Fontane & Beverini Napoli</title>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Caricamento...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="images/logo-comune.png" alt="Comune di Napoli" class="comune-logo" id="admin-logo">
                    <div class="title-section">
                        <h1>Fontane & Beverini</h1>
                        <p class="subtitle">Comune di Napoli</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="searchBtn" class="btn-icon">
                        <i class="fas fa-search"></i>
                    </button>
                    <button id="filterBtn" class="btn-icon">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button id="refreshBtn" class="btn-icon">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div id="searchBar" class="search-container hidden">
                <input type="text" id="searchInput" placeholder="Cerca per indirizzo o nome...">
                <button id="clearSearch" class="btn-clear">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Filter Panel -->
            <div id="filterPanel" class="filter-container hidden">
                <div class="filter-group">
                    <h3>Filtra per Stato</h3>
                    <div class="filter-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filterWorking" checked>
                            <span class="checkmark"></span>
                            <span class="status-dot working"></span>
                            Funzionanti
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="filterNotWorking" checked>
                            <span class="checkmark"></span>
                            <span class="status-dot not-working"></span>
                            Non Funzionanti
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="filterMaintenance" checked>
                            <span class="checkmark"></span>
                            <span class="status-dot maintenance"></span>
                            In Manutenzione
                        </label>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>Tipologia</h3>
                    <div class="filter-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filterFountains" checked>
                            <span class="checkmark"></span>
                            Fontane
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="filterBeverini" checked>
                            <span class="checkmark"></span>
                            Beverini
                        </label>
                    </div>
                </div>
                <button id="applyFilters" class="btn-primary">Applica Filtri</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Screen -->
        <section id="home-screen" class="screen active">
            <div class="hero-banner">
                <img src="images/sfondo-home.jpg" alt="Fontane di Napoli">
                <div class="hero-overlay">
                    <h2>Acqua Pubblica Napoli</h2>
                    <p>Scopri le fontane e i beverini della tua città</p>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-fountain"></i>
                    </div>
                    <h3>Fontane</h3>
                    <p class="stat-number" id="totalFountains">0</p>
                    <small>Registrate</small>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <h3>Beverini</h3>
                    <p class="stat-number" id="totalBeverini">0</p>
                    <small>Registrati</small>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Funzionanti</h3>
                    <p class="stat-number" id="totalWorking">0</p>
                    <small>Attualmente</small>
                </div>
            </div>
            
            <div class="quick-links">
                <a href="#fontane" class="quick-link">
                    <div class="link-icon">
                        <i class="fas fa-fountain"></i>
                    </div>
                    <span>Fontane</span>
                </a>
                <a href="#beverini" class="quick-link">
                    <div class="link-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <span>Beverini</span>
                </a>
                <a href="#mappa" class="quick-link">
                    <div class="link-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <span>Mappa</span>
                </a>
                <a href="#news" class="quick-link">
                    <div class="link-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <span>News</span>
                </a>
            </div>
            
            <div class="news-section">
                <h3>Ultime News</h3>
                <div id="newsPreview" class="news-preview">
                    <!-- News caricate dinamicamente -->
                </div>
            </div>
        </section>

        <!-- Fontane Screen -->
        <section id="fontane-screen" class="screen">
            <div class="screen-header">
                <h2>Elenco Fontane</h2>
                <button id="addFontanaBtn" class="btn-add hidden">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="fontaneList" class="list-container">
                <!-- Fontane caricate dinamicamente -->
            </div>
        </section>

        <!-- Beverini Screen -->
        <section id="beverini-screen" class="screen">
            <div class="screen-header">
                <h2>Elenco Beverini</h2>
                <button id="addBeverinoBtn" class="btn-add hidden">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="beveriniList" class="list-container">
                <!-- Beverini caricati dinamicamente -->
            </div>
        </section>

        <!-- Mappa Screen -->
        <section id="mappa-screen" class="screen">
            <div class="screen-header">
                <h2>Mappa Interattiva</h2>
                <div class="map-controls">
                    <button id="locateMe" class="btn-icon">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button id="toggleMapType" class="btn-icon">
                        <i class="fas fa-layer-group"></i>
                    </button>
                </div>
            </div>
            <div id="map" class="map-container"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <span class="legend-color working"></span>
                    <span>Funzionante</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color not-working"></span>
                    <span>Non Funzionante</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color maintenance"></span>
                    <span>Manutenzione</span>
                </div>
            </div>
        </section>

        <!-- News Screen -->
        <section id="news-screen" class="screen">
            <div class="screen-header">
                <h2>News & Aggiornamenti</h2>
                <button id="addNewsBtn" class="btn-add hidden">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="newsContainer" class="news-container">
                <!-- News complete caricate dinamicamente -->
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#home" class="nav-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#fontane" class="nav-item">
            <i class="fas fa-fountain"></i>
            <span>Fontane</span>
        </a>
        <a href="#beverini" class="nav-item">
            <i class="fas fa-tint"></i>
            <span>Beverini</span>
        </a>
        <a href="#mappa" class="nav-item">
            <i class="fas fa-map-marked-alt"></i>
            <span>Mappa</span>
        </a>
        <a href="#news" class="nav-item">
            <i class="fas fa-newspaper"></i>
            <span>News</span>
        </a>
    </nav>

    <!-- Admin Modal -->
    <div id="adminModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Accesso Amministratore</h3>
                <button id="closeAdmin" class="btn-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <input type="email" id="adminEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="adminPassword" placeholder="Password" required>
                    </div>
                    <button id="loginBtn" class="btn-primary btn-block">Accedi</button>
                    <p id="loginError" class="error-message"></p>
                </div>
                <div id="adminPanel" class="hidden">
                    <div class="admin-section">
                        <h4>Gestione Dati</h4>
                        <button id="syncData" class="btn-admin">
                            <i class="fas fa-sync"></i> Sincronizza con Firebase
                        </button>
                        <button id="exportData" class="btn-admin">
                            <i class="fas fa-file-export"></i> Esporta Excel
                        </button>
                        <button id="importData" class="btn-admin">
                            <i class="fas fa-file-import"></i> Importa Excel
                        </button>
                        <button id="backupData" class="btn-admin">
                            <i class="fas fa-database"></i> Backup Locale
                        </button>
                    </div>
                    <div class="admin-section">
                        <h4>Statistiche</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>Fontane:</span>
                                <span id="adminFountains">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Beverini:</span>
                                <span id="adminBeverini">0</span>
                            </div>
                            <div class="stat-item">
                                <span>News:</span>
                                <span id="adminNews">0</span>
                            </div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailTitle"></h3>
                <button id="closeDetail" class="btn-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detailBody">
                <!-- Dettagli caricati dinamicamente -->
            </div>
            <div class="modal-footer">
                <button id="navigateBtn" class="btn-primary">
                    <i class="fas fa-directions"></i> Naviga
                </button>
                <button id="reportBtn" class="btn-secondary">
                    <i class="fas fa-flag"></i> Segnala
                </button>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt hidden">
        <div class="prompt-content">
            <p><i class="fas fa-download"></i> Installa l'app per un'esperienza migliore!</p>
            <div class="prompt-actions">
                <button id="installBtn" class="btn-primary">Installa</button>
                <button id="dismissPrompt" class="btn-secondary">Più tardi</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvDfxm-LSAcu0NwtJ8DYxxrjY-83LlLPU",
            authDomain: "abcnapolifontane.firebaseapp.com",
            projectId: "abcnapolifontane",
            storageBucket: "abcnapolifontane.firebasestorage.app",
            messagingSenderId: "686936372148",
            appId: "1:686936372148:web:4147bab1bab73583b638e1"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        
        console.log("Firebase inizializzato correttamente");
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Admin autenticato:", user.email);
                window.isAdmin = true;
                document.querySelectorAll('.btn-add').forEach(btn => btn.classList.remove('hidden'));
            } else {
                console.log("Nessun admin autenticato");
                window.isAdmin = false;
                document.querySelectorAll('.btn-add').forEach(btn => btn.classList.add('hidden'));
            }
        });
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Main App JS -->
    <script src="app.js"></script>
    
    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker errore:', error);
                    });
            });
        }
        
        // Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('installPrompt').classList.remove('hidden');
            }, 3000);
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('PWA installata');
                }
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.add('hidden');
            }
        });
        
        document.getElementById('dismissPrompt').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.add('hidden');
        });
    </script>
</body>
</html>