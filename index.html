<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ABC Napoli F&B</title>
    
    <meta name="application-name" content="ABC Napoli F&B">
    <meta name="description" content="Gestione intelligente delle risorse idriche cittadine">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ABC Napoli F&B">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-TileColor" content="#3b82f6">
    
    <meta name="display" content="standalone">
    <meta name="orientation" content="portrait">
    
    <link rel="manifest" href="./manifest.json">
    
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
    
    <link rel="apple-touch-icon" href="./images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./images/icona-avvio-144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./images/icona-avvio-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./images/icona-avvio-512.png">
    
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" 
          href="./images/icona-avvio-splash.png"
          media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    
    <meta name="theme-color" content="#3b82f6">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ABC Napoli F&B">
    
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-TileImage" content="./images/icona-avvio-144.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvDfxm-LSAcu0NwtJ8DYxxrjY-83LlLPU",
            authDomain: "abcnapolifontane.firebaseapp.com",
            projectId: "abcnapolifontane",
            storageBucket: "abcnapolifontane.firebasestorage.app",
            messagingSenderId: "686936372148",
            appId: "1:686936372148:web:4147bab1bab73583b638e1",
            measurementId: "G-DPEC2SNGDM"
        };
        
        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        
        // Inizializza i servizi Firebase
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.firebaseAnalytics = getAnalytics(app);
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.app = app;
        
        console.log('Firebase inizializzato con Analytics');
    </script>
    <link rel="stylesheet" href="./style.css">

    <script>
        // Gestione scroll per ancore
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const headerHeight = document.querySelector('header') ? document.querySelector('header').offsetHeight : 0;
                        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
    </head>
<body>
    <div id="splash-screen">
        <div class="splash-container">
            <img src="./images/icona-avvio-splash.png" alt="ABC Napoli F&B" class="splash-image">
            <div class="splash-progress">
                <div class="splash-progress-bar"></div>
            </div>
            <p class="splash-text">Caricamento in corso...</p>
        </div>
    </div>
    
    <div class="offline-indicator" id="offline-indicator">
        <i class="fas fa-wifi"></i> Connessione assente
    </div>
    <div class="toast" id="toast"></div>

    <div class="auth-overlay" id="admin-auth">
        <div class="auth-modal">
            <h2 class="auth-title">Accesso Amministratore</h2>
            <input type="email" class="auth-input" id="admin-email" placeholder="Email">
            <input type="password" class="auth-input" id="admin-password" placeholder="Password" autocomplete="off">
            <button class="auth-btn" onclick="checkAdminAuth()">Accedi</button>
            <div class="auth-error" id="auth-error">Credenziali non valide</div>
            <button class="auth-btn secondary" onclick="closeAdminAuth()" style="background: #6b7280;">Annulla</button>
        </div>
    </div>

    <div class="modal-overlay" id="navigation-modal">
        <div class="modal-content">
            <h3 class="modal-title">Scegli l'app di navigazione</h3>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="openGoogleMaps()">
                    <i class="fas fa-map-marked-alt"></i> Google Maps
                </button>
                <button class="modal-btn primary" onclick="openAppleMaps()">
                    <i class="fas fa-map-marked-alt"></i> Apple Maps
                </button>
                <button class="modal-btn secondary" onclick="closeNavigationModal()">
                    <i class="fas fa-times"></i> Annulla
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-content">
            <h3 class="modal-title" id="info-modal-title">Informazioni</h3>
            <p id="info-modal-message"></p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeInfoModal()">OK</button>
            </div>
        </div>
    </div>

    <div class="admin-panel-overlay" id="admin-panel">
        <div class="admin-panel-content">
            <header class="admin-panel-header">
                <h2>Pannello di Controllo</h2>
                <button class="close-admin-panel" onclick="closeAdminPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </header>

            <div class="admin-config-section">
                </div>

            <div class="admin-tabs">
                <button class="admin-tab-btn active" data-tab="dashboard-admin">Dashboard</button>
                <button class="admin-tab-btn" data-tab="fontane-admin">Fontane</button>
                <button class="admin-tab-btn" data-tab="beverini-admin">Beverini</button>
                <button class="admin-tab-btn" data-tab="news-admin">News</button>
                <button class="admin-tab-btn" data-tab="analytics-admin">Analytics</button>
                <button class="admin-tab-btn" data-tab="config-admin">Configurazione</button>
            </div>

            <div class="admin-tab-content active" id="dashboard-admin">
                <div class="dashboard-stats">
                    <div class="stat-card fontane">
                        <div class="stat-title">Fontane Totali</div>
                        <div class="stat-value" id="total-fontane">0</div>
                        <div class="stat-details">
                            <div class="stat-detail">
                                <div class="detail-value status-funzionante" id="fontane-funzionanti">0</div>
                                <div class="detail-label">Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-non-funzionante" id="fontane-non-funzionanti">0</div>
                                <div class="detail-label">Non Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-manutenzione" id="fontane-manutenzione">0</div>
                                <div class="detail-label">In Manutenzione</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card beverini">
                        <div class="stat-title">Beverini Totali</div>
                        <div class="stat-value" id="total-beverini">0</div>
                        <div class="stat-details">
                            <div class="stat-detail">
                                <div class="detail-value status-funzionante" id="beverini-funzionanti">0</div>
                                <div class="detail-label">Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-non-funzionante" id="beverini-non-funzionanti">0</div>
                                <div class="detail-label">Non Funzionanti</div>
                            </div>
                            <div class="stat-detail">
                                <div class="detail-value status-manutenzione" id="beverini-manutenzione">0</div>
                                <div class="detail-label">In Manutenzione</div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card news">
                        <div class="stat-title">News Totali</div>
                        <div class="stat-value" id="total-news">0</div>
                    </div>
                </div>

                <div class="recent-activity">
                    <div class="activity-title">
                        <span>Attivit√† Recenti</span>
                        <button class="admin-btn secondary" onclick="clearActivityLog()">
                            <i class="fas fa-trash"></i> Pulisci
                        </button>
                    </div>
                    <div class="activity-list" id="activity-list">
                    </div>
                </div>
            </div>

            <div class="admin-tab-content" id="fontane-admin">
                <div class="import-export-section">
                    <h4>Import/Export Fontane</h4>
                    <div class="import-options">
                        <input type="file" id="import-fontane-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('fontane', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-fontane-file').click()">
                            <i class="fas fa-file-import"></i> Importa Fontane
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('fontane')">
                            <i class="fas fa-file-export"></i> Esporta Fontane
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('fontane')">
                            <i class="fas fa-download"></i> Template Fontane
                        </button>
                    </div>
                </div>

                <h3>Aggiungi/Modifica Fontana</h3>
                <form id="fontana-form" onsubmit="saveFontana(event)">
                    <input type="hidden" id="fontana-id">
                    <div class="form-group">
                        <label for="fontana-nome">Nome:</label>
                        <input type="text" id="fontana-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="fontana-indirizzo">Indirizzo:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <input type="text" id="fontana-indirizzo" required style="flex: 1;">
                            <button type="button" class="location-btn secondary" onclick="getCurrentLocationWithAddress('fontana')"
                                    title="Usa la posizione corrente per coordinate e indirizzo">
                                <i class="fas fa-location-arrow"></i> Rileva Automatico
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-stato">Stato:</label>
                        <select id="fontana-stato" required>
                            <option value="funzionante">Funzionante</option>
                            <option value="non-funzionante">Non Funzionante</option>
                            <option value="manutenzione">In Manutenzione</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fontana-anno">Anno:</label>
                        <input type="text" id="fontana-anno">
                    </div>
                    <div class="form-group">
                        <label for="fontana-descrizione">Descrizione:</label>
                        <textarea id="fontana-descrizione" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fontana-storico">Storico:</label>
                        <textarea id="fontana-storico" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="fontana-latitudine">Coordinate:</label>
                        <div style="margin-bottom: 8px;">
                            <div class="location-buttons">
                                <button type="button" class="location-btn primary" onclick="getCurrentLocationCoordinatesOnly('fontana')">
                                    <i class="fas fa-location-arrow"></i> Solo Coordinate
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Latitudine</label>
                                <input type="text" id="fontana-latitudine" required placeholder="40.8518">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Longitudine</label>
                                <input type="text" id="fontana-longitudine" required placeholder="14.2681">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fontana-immagine">URL Immagine:</label>
                        <input type="text" id="fontana-immagine">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="admin-btn primary">Salva</button>
                        <button type="button" class="admin-btn secondary" onclick="resetFontanaForm()">Annulla</button>
                    </div>
                </form>

                <div class="admin-table-container">
                    <table class="admin-table" id="fontane-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Indirizzo</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="fontane-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="beverini-admin">
                <div class="import-export-section">
                    <h4>Import/Export Beverini</h4>
                    <div class="import-options">
                        <input type="file" id="import-beverini-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('beverini', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-beverini-file').click()">
                            <i class="fas fa-file-import"></i> Importa Beverini
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('beverini')">
                            <i class="fas fa-file-export"></i> Esporta Beverini
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('beverini')">
                            <i class="fas fa-download"></i> Template Beverini
                        </button>
                    </div>
                </div>

                <h3>Aggiungi/Modifica Beverino</h3>
                <form id="beverino-form" onsubmit="saveBeverino(event)">
                    <input type="hidden" id="beverino-id">
                    <div class="form-group">
                        <label for="beverino-nome">Nome:</label>
                        <input type="text" id="beverino-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="beverino-indirizzo">Indirizzo:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                            <input type="text" id="beverino-indirizzo" required style="flex: 1;">
                            <button type="button" class="location-btn secondary" onclick="getCurrentLocationWithAddress('beverino')"
                                    title="Usa la posizione corrente per coordinate e indirizzo">
                                <i class="fas fa-location-arrow"></i> Rileva Automatico
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-stato">Stato:</label>
                        <select id="beverino-stato" required>
                            <option value="funzionante">Funzionante</option>
                            <option value="non-funzionante">Non Funzionante</option>
                            <option value="manutenzione">In Manutenzione</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="beverino-descrizione">Descrizione:</label>
                        <textarea id="beverino-descrizione" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="beverino-latitudine">Coordinate:</label>
                        <div style="margin-bottom: 8px;">
                            <div class="location-buttons">
                                <button type="button" class="location-btn primary" onclick="getCurrentLocationCoordinatesOnly('beverino')">
                                    <i class="fas fa-location-arrow"></i> Solo Coordinate
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Latitudine</label>
                                <input type="text" id="beverino-latitudine" required placeholder="40.8518">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--light-text);">Longitudine</label>
                                <input type="text" id="beverino-longitudine" required placeholder="14.2681">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="beverino-immagine">URL Immagine:</label>
                        <input type="text" id="beverino-immagine">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="admin-btn primary">Salva</button>
                        <button type="button" class="admin-btn secondary" onclick="resetBeverinoForm()">Annulla</button>
                    </div>
                </form>

                <div class="admin-table-container">
                    <table class="admin-table" id="beverini-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Indirizzo</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="beverini-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="news-admin">
                <div class="import-export-section">
                    <h4>Import/Export News</h4>
                    <div class="import-options">
                        <input type="file" id="import-news-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('news', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-news-file').click()">
                            <i class="fas fa-file-import"></i> Importa News
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('news')">
                            <i class="fas fa-file-export"></i> Esporta News
                        </button>
                        <button class="admin-btn secondary" onclick="downloadTemplate('news')">
                            <i class="fas fa-download"></i> Template News
                        </button>
                    </div>
                </div>

                <h3>Aggiungi/Modifica News</h3>
                <form id="news-form" onsubmit="saveNews(event)">
                    <input type="hidden" id="news-id">
                    <div class="form-group">
                        <label for="news-titolo">Titolo:</label>
                        <input type="text" id="news-titolo" required>
                    </div>
                    <div class="form-group">
                        <label for="news-contenuto">Contenuto:</label>
                        <textarea id="news-contenuto" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="news-data">Data:</label>
                        <input type="date" id="news-data" required>
                    </div>
                    <div class="form-group">
                        <label for="news-categoria">Categoria:</label>
                        <input type="text" id="news-categoria" required>
                    </div>
                    <div class="form-group">
                        <label for="news-fonte">Fonte:</label>
                        <input type="text" id="news-fonte" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="admin-btn primary">Salva</button>
                        <button type="button" class="admin-btn secondary" onclick="resetNewsForm()">Annulla</button>
                    </div>
                </form>

                <div class="admin-table-container">
                    <table class="admin-table" id="news-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Titolo</th>
                                <th>Data</th>
                                <th>Categoria</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="news-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-tab-content" id="analytics-admin">
                <div class="analytics-header">
                    <h3>Dashboard Analytics</h3>
                    <p>Monitora le attivit√† degli utenti e le prestazioni dell'app</p>
                </div>
                
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-blue);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-session-count">0</div>
                        <div class="analytics-stat-label">Sessioni Oggi</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-green);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-events-count">0</div>
                        <div class="analytics-stat-label">Eventi Oggi</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-purple);">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-pageviews-count">0</div>
                        <div class="analytics-stat-label">Page Views</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="analytics-stat-icon" style="background: var(--primary-red);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="analytics-stat-value" id="analytics-errors-count">0</div>
                        <div class="analytics-stat-label">Errori Oggi</div>
                    </div>
                </div>
                
                <div class="analytics-charts-section">
                    <div class="analytics-chart-container">
                        <h4>Attivit√† Utenti (Ultimi 7 giorni)</h4>
                        <canvas id="activity-chart"></canvas>
                        <div class="performance-metrics">
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento pagine:</span>
                                <span class="metric-value" id="metric-page-load">0ms</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento immagini:</span>
                                <span class="metric-value" id="metric-image-load">0ms</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo medio caricamento dati:</span>
                                <span class="metric-value" id="metric-data-load">0ms</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-chart-container">
                        <h4>Stato Sistema</h4>
                        <div class="analytics-status">
                            <div class="status-indicator" id="analytics-status-indicator">
                                <i class="fas fa-circle"></i>
                                <span id="analytics-status-text">Analytics Attivo</span>
                            </div>
                            <div class="session-info">
                                <div>Session ID: <code id="current-session-id">...</code></div>
                                <div>User ID: <code id="current-user-id">...</code></div>
                                <div>Ultimo sync: <span id="last-sync-time">Mai</span></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px;">
                            <h5 style="margin-bottom: 10px;">Storage Utilizzato</h5>
                            <div class="performance-metric">
                                <span class="metric-label">Eventi archiviati:</span>
                                <span class="metric-value" id="storage-events">0</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Errori archiviati:</span>
                                <span class="metric-value" id="storage-errors">0</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Storage totale:</span>
                                <span class="metric-value" id="storage-used">0 KB</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-tables-section">
                    <div class="analytics-table-container">
                        <h4>Errori Recenti</h4>
                        <div class="analytics-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Data/Ora</th>
                                        <th>Contesto</th>
                                        <th>Messaggio</th>
                                        <th>Severit√†</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-errors-table">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="analytics-table-container">
                        <h4>Eventi Pi√π Frequenti</h4>
                        <div class="analytics-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Azione</th>
                                        <th>Conteggio</th>
                                        <th>Ultimo</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-events-table">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-actions-section">
                    <h4>Azioni Analytics</h4>
                    <div class="analytics-actions">
                        <button class="admin-btn primary" onclick="refreshAnalyticsDashboard()">
                            <i class="fas fa-sync-alt"></i> Aggiorna Dashboard
                        </button>
                        <button class="admin-btn secondary" onclick="exportAnalyticsData()">
                            <i class="fas fa-download"></i> Esporta Dati
                        </button>
                        <button class="admin-btn secondary" onclick="toggleAnalyticsTracking()">
                            <i class="fas fa-toggle-on"></i> Attiva/Disattiva
                        </button>
                        <button class="admin-btn danger" onclick="resetAnalyticsData()">
                            <i class="fas fa-trash"></i> Resetta Dati
                        </button>
                    </div>
                    
                    <div class="sync-section">
                        <h4>Stato Sincronizzazione</h4>
                        <div id="sync-status">
                            <div class="analytics-status">
                                <div class="status-indicator" id="sync-status-indicator">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="sync-status-text">Sincronizzato</span>
                                </div>
                                <div class="session-info">
                                    <div>Eventi in coda: <span id="pending-events-count">0</span></div>
                                    <div>Ultimo invio: <span id="last-send-time">Mai</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="sync-actions" style="margin-top: 10px;">
                            <button class="admin-btn primary" onclick="forceSyncAnalytics()">
                                <i class="fas fa-sync"></i> Forza Sincronizzazione
                            </button>
                            <button class="admin-btn secondary" onclick="clearAnalyticsErrors()">
                                <i class="fas fa-broom"></i> Pulisci Errori
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-debug-section">
                    <h4>Debug & Test</h4>
                    <div class="debug-controls">
                        <button class="admin-btn secondary" onclick="testAnalyticsEvent()">
                            <i class="fas fa-vial"></i> Test Evento
                        </button>
                        <button class="admin-btn secondary" onclick="testAnalyticsError()">
                            <i class="fas fa-bug"></i> Test Errore
                        </button>
                        <button class="admin-btn secondary" onclick="testPerformanceMetric()">
                            <i class="fas fa-tachometer-alt"></i> Test Performance
                        </button>
                    </div>
                    
                    <div class="debug-info">
                        <div class="info-item">
                            <span>Analytics Inizializzato:</span>
                            <span id="debug-initialized">No</span>
                        </div>
                        <div class="info-item">
                            <span>Firebase Analytics:</span>
                            <span id="debug-firebase">No</span>
                        </div>
                        <div class="info-item">
                            <span>Modalit√† PWA:</span>
                            <span id="debug-pwa">No</span>
                        </div>
                        <div class="info-item">
                            <span>Connessione:</span>
                            <span id="debug-online">No</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-tab-content" id="config-admin">
                <div class="backup-section">
                    <h4>Sicurezza Amministratore</h4>
                    <div class="sync-actions">
                        <button class="admin-btn secondary" onclick="logoutAdmin()">
                            <i class="fas fa-sign-out-alt"></i> Logout Amministratore
                        </button>
                    </div>
                </div>

                <div class="import-export-section">
                    <h4>Import/Export Dati in Excel</h4>
                    <div class="export-options">
                        <button class="admin-btn secondary" onclick="exportDataToExcel('fontane')">
                            <i class="fas fa-file-export"></i> Esporta Fontane
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('beverini')">
                            <i class="fas fa-file-export"></i> Esporta Beverini
                        </button>
                        <button class="admin-btn secondary" onclick="exportDataToExcel('news')">
                            <i class="fas fa-file-export"></i> Esporta News
                        </button>
                        <button class="admin-btn primary" onclick="exportAllDataToExcel()">
                            <i class="fas fa-file-archive"></i> Esporta Tutto
                        </button>
                    </div>

                    <div class="import-options">
                        <input type="file" id="import-all-file" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileImport('all', this.files)">
                        <button class="admin-btn secondary" onclick="document.getElementById('import-all-file').click()">
                            <i class="fas fa-file-import"></i> Importa Tutto
                        </button>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Configurazione Analytics</h4>
                    <div class="config-item">
                        <label for="analytics-enabled">Tracciamento Attivo:</label>
                        <input type="checkbox" id="analytics-enabled" checked onchange="toggleAnalytics(this.checked)">
                    </div>
                    <div class="config-item">
                        <label for="error-logging">Log Errori:</label>
                        <input type="checkbox" id="error-logging" checked>
                    </div>
                    <div class="config-item">
                        <label for="performance-tracking">Tracciamento Performance:</label>
                        <input type="checkbox" id="performance-tracking" checked>
                    </div>
                    <div class="config-status" id="config-status"></div>
                </div>

                <div class="config-section">
                    <h4>Configurazione Offline</h4>
                    <div class="config-item">
                        <label for="offline-mode">Modalit√† Offline:</label>
                        <input type="checkbox" id="offline-mode" checked>
                    </div>
                    <div class="config-item">
                        <label for="auto-sync">Sincronizzazione Automatica:</label>
                        <input type="checkbox" id="auto-sync" checked>
                    </div>
                    <div class="config-item">
                        <label for="sync-interval">Intervallo Sync (min):</label>
                        <input type="number" id="sync-interval" value="5" min="1" max="60">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="admin-icon-btn-container">
            <button class="admin-icon-btn" onclick="toggleMenuModal()">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <div class="screen active" id="home-screen">
            <div class="logo-container">
                <div class="app-logo logo-with-image"></div>
                <div class="comune-logo"></div>
            </div>
            <h1 class="home-title">Fontane & Beverini</h1>
            <p class="home-subtitle">
                L'acqua pubblica a portata di app.
                Fontane, e beverini della citt√† di Napoli, sempre nel palmo della tua mano.
            </p>
            <p class="home-welcome-animated" style="display: none;">NAPOLI</p>
            <div class="home-buttons">
                <div class="button-row">
                    <button class="home-btn fontane-btn" onclick="showScreen('fontane-screen')">
                        <span class="btn-icon"><i class="fas fa-monument"></i></span>
                        <span class="btn-text">Fontane</span>
                    </button>
                    <button class="home-btn beverini-btn" onclick="showScreen('beverini-screen')">
                        <span class="btn-icon"><i class="fas fa-faucet"></i></span>
                        <span class="btn-text">Beverini</span>
                    </button>
                </div>
                <div class="button-row">
                    <button class="home-btn mappa-btn" onclick="showScreen('mappa-screen')">
                        <span class="btn-icon"><i class="fas fa-map-marked-alt"></i></span>
                        <span class="btn-text">Mappa</span>
                    </button>
                    <button class="home-btn news-btn" onclick="showScreen('news-screen')">
                        <span class="btn-icon"><i class="fas fa-newspaper"></i></span>
                        <span class="btn-text">News</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="screen list-screen" id="fontane-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title">Fontane</h1>
                <p class="screen-subtitle">Scopri le fontane della citt√†</p>
            </header>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="üîç Cerca fontane..." onkeyup="debouncedFilter('fontane', this.value)">
            </div>
            <div class="content-area">
                <div class="filter-buttons">
                    <button class="filter-btn all active" onclick="setFilter('fontane', 'all')">
                        <i class="fas fa-layer-group"></i> Tutti
                    </button>
                    <button class="filter-btn funzionante" onclick="setFilter('fontane', 'funzionante')">
                        <i class="fas fa-check-circle"></i> Funzionanti
                    </button>
                    <button class="filter-btn non-funzionante" onclick="setFilter('fontane', 'non-funzionante')">
                        <i class="fas fa-times-circle"></i> Non Funzionanti
                    </button>
                    <button class="filter-btn manutenzione" onclick="setFilter('fontane', 'manutenzione')">
                        <i class="fas fa-tools"></i> In Manutenzione
                    </button>
                </div>
                <div class="items-grid" id="fontane-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento fontane in corso...</p>
                    </div>
                </div>
            </div>
            <button class="fixed-navigate-btn hidden" id="fixed-navigate-btn" onclick="navigateToFixed()">
                <i class="fas fa-map-marker-alt"></i> Naviga Verso
            </button>
        </div>

        <div class="screen list-screen" id="beverini-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title">Beverini</h1>
                <p class="screen-subtitle">Trova i beverini pubblici</p>
            </header>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="üîç Cerca beverini..." onkeyup="debouncedFilter('beverini', this.value)">
            </div>
            <div class="content-area">
                <div class="filter-buttons">
                    <button class="filter-btn all active" onclick="setFilter('beverini', 'all')">
                        <i class="fas fa-layer-group"></i> Tutti
                    </button>
                    <button class="filter-btn funzionante" onclick="setFilter('beverini', 'funzionante')">
                        <i class="fas fa-check-circle"></i> Funzionanti
                    </button>
                    <button class="filter-btn non-funzionante" onclick="setFilter('beverini', 'non-funzionante')">
                        <i class="fas fa-times-circle"></i> Non Funzionanti
                    </button>
                    <button class="filter-btn manutenzione" onclick="setFilter('beverini', 'manutenzione')">
                        <i class="fas fa-tools"></i> In Manutenzione
                    </button>
                </div>
                <div class="compact-items-list" id="beverini-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento beverini in corso...</p>
                    </div>
                </div>
            </div>
            <button class="fixed-navigate-btn hidden" id="fixed-navigate-btn" onclick="navigateToFixed()">
                <i class="fas fa-map-marker-alt"></i> Naviga Verso
            </button>
        </div>

        <div class="screen list-screen" id="news-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title">News</h1>
                <p class="screen-subtitle">Ultime notizie sulle fontane</p>
            </header>
            <div class="content-area">
                <div class="news-container" id="news-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento news in corso...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="screen detail-screen" id="fontana-detail-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" id="fontana-detail-title">Fontana</h1>
            </header>
            <div class="detail-content" id="fontana-detail-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <button class="fixed-navigate-btn hidden" id="fixed-navigate-btn" onclick="navigateToFixed()">
                <i class="fas fa-map-marker-alt"></i> Naviga Verso
            </button>
        </div>

        <div class="screen detail-screen" id="beverino-detail-screen">
            <header class="app-header">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" id="beverino-detail-title">Beverino</h1>
            </header>
            <div class="detail-content" id="beverino-detail-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <button class="fixed-navigate-btn hidden" id="fixed-navigate-btn" onclick="navigateToFixed()">
                <i class="fas fa-map-marker-alt"></i> Naviga Verso
            </button>
        </div>

        <div class="screen" id="mappa-screen">
            <header class="app-header" style="position: absolute; top: 0; left: 0; right: 0; z-index: 1000; padding: 15px 20px;">
                <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                <h1 class="screen-title" style="font-size: 1.4rem;">Mappa</h1>
            </header>
            <div class="map-search-container">
                <div class="map-search-box">
                    <input type="text" id="map-search-input" placeholder="üîç Cerca indirizzo, luogo, punto interesse..."
                           onkeypress="handleMapSearch(event)">
                    <button class="map-search-btn" onclick="performMapSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="search-results" id="map-search-results"></div>
            </div>
            <div id="map" class="map-container"></div>
            <div class="map-legend">
                <div class="legend-title">Legenda</div>
                <div class="legend-item">
                    <div class="legend-icon icon-fontana"></div>
                    <span>Fontana</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon icon-beverino"></div>
                    <span>Beverini</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon icon-position"></div>
                    <span>La tua posizione</span>
                </div>
            </div>
            <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; z-index: 1000;">
                ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors
            </div>
        </div>

        <div id="segnalazioni-screen" class="screen">
            <div class="app-header" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">
                <button class="back-btn" onclick="showScreen('home-screen')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title">Segnalazione</div>
            </div>

            <div class="content-area">
                <div class="report-form-container" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem; line-height:1.5;">
                        Hai notato un problema? Compila il modulo. <br>
                        Si aprir√† la tua app di posta per inviare una mail ufficiale a <b>ABC Napoli</b>.
                    </p>

                    <form onsubmit="inviaSegnalazione(event)">
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="font-weight:600; display:block; margin-bottom:8px;">Tipo segnalazione</label>
                            <select id="report-type" class="form-input" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; background: #f9f9f9;">
                                <option value="Guasto">Guasto / Non eroga acqua</option>
                                <option value="Perdita">Perdita d'acqua</option>
                                <option value="Sporcizia">Pulizia/Manutenzione</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom:25px;">
                            <label style="font-weight:600; display:block; margin-bottom:8px;">Descrizione e Posizione</label>
                            <textarea id="report-desc" rows="5" placeholder="Esempio: La fontanella in Piazza Plebiscito perde acqua dalla base..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; background: #f9f9f9; font-family:inherit; resize:none;"></textarea>
                        </div>

                        <button type="submit" style="width:100%; padding:15px; background: linear-gradient(135deg, #ef4444, #b91c1c); color:white; border:none; border-radius:12px; font-weight:700; font-size:1.1rem; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">
                            <i class="fas fa-paper-plane"></i> INVIA EMAIL
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="tab-bar">
                <button class="tab-btn" onclick="showScreen('home-screen')"><span class="tab-icon"><i class="fas fa-home"></i></span><span>Home</span></button>
                <button class="tab-btn" onclick="showScreen('fontane-screen')"><span class="tab-icon"><i class="fas fa-monument"></i></span><span>Fontane</span></button>
                <button class="tab-btn" onclick="showScreen('beverini-screen')"><span class="tab-icon"><i class="fas fa-faucet"></i></span><span>Beverini</span></button>
                <button class="tab-btn" onclick="showScreen('mappa-screen')"><span class="tab-icon"><i class="fas fa-map-marked-alt"></i></span><span>Mappa</span></button>
                <button class="tab-btn" onclick="showScreen('news-screen')"><span class="tab-icon"><i class="fas fa-newspaper"></i></span><span>News</span></button>
            </div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" data-target="home-screen" onclick="showScreen('home-screen')">
                <span class="tab-icon"><i class="fas fa-home"></i></span>
                <span>Home</span>
            </button>
            <button class="tab-btn" data-target="fontane-screen" onclick="showScreen('fontane-screen')">
                <span class="tab-icon"><i class="fas fa-monument"></i></span>
                <span>Fontane</span>
            </button>
            <button class="tab-btn" data-target="beverini-screen" onclick="showScreen('beverini-screen')">
                <span class="tab-icon"><i class="fas fa-faucet"></i></span>
                <span>Beverini</span>
            </button>
            <button class="tab-btn" data-target="mappa-screen" onclick="showScreen('mappa-screen')">
                <span class="tab-icon"><i class="fas fa-map-marked-alt"></i></span>
                <span>Mappa</span>
            </button>
            <button class="tab-btn" data-target="news-screen" onclick="showScreen('news-screen')">
                <span class="tab-icon"><i class="fas fa-newspaper"></i></span>
                <span>News</span>
            </button>
        </div>
    </div>

    <div id="top-menu-modal" class="modal-overlay" onclick="closeMenuModal(event)" style="z-index: 9999;">
        <div class="modal-content menu-modal-content" style="width: 280px; padding: 20px; position: absolute; top: 70px; right: 20px;">
            <h3 class="modal-title" style="margin-bottom: 20px; font-size:1.2rem;">Menu</h3>
            
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="openReportScreen()" style="background: #ef4444;">
                    <i class="fas fa-bullhorn"></i> Invia Segnalazione
                </button>
                
                <button class="modal-btn secondary" onclick="goToAdmin()">
                    <i class="fas fa-user-shield"></i> Area Riservata
                </button>
                
                <button class="modal-btn" onclick="toggleMenuModal()" style="border: 1px solid #ddd; background:white; margin-top:10px;">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script src="./app.js"></script>
    
    <script src="./analytics.js" defer></script>
    
    <script>
        // ‚úÖ SERVICE WORKER REGISTRATION - VERSIONE ROBUSTA PER GITHUB PAGES
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swUrl = './sw.js';
                
                // Prima verifica se il file esiste
                fetch(swUrl, { mode: 'no-cors' })
                  .then(response => {
                      // Usa no-cors mode per evitare CORS issues su GitHub Pages
                      return navigator.serviceWorker.register(swUrl)
                          .then(registration => {
                              console.log('‚úÖ Service Worker registrato con successo:', registration.scope);
                              
                              // Controlla aggiornamenti
                              registration.addEventListener('updatefound', () => {
                                  const newWorker = registration.installing;
                                  console.log('üîÑ Nuova versione del Service Worker trovata');
                                  
                                  newWorker.addEventListener('statechange', () => {
                                      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                          console.log('üì¶ Nuova versione pronta per l\'aggiornamento');
                                          showToast('Nuova versione disponibile! Ricarica la pagina.', 'info');
                                      }
                                  });
                              });
                              
                              return registration;
                          });
                  })
                  .catch(error => {
                      console.warn('‚ö†Ô∏è Registrazione Service Worker fallita:', error.message);
                      // Non bloccare l'app se il Service Worker fallisce
                      showToast('Modalit√† offline limitata', 'warning');
                  });
            });
        } else {
            console.log('‚ÑπÔ∏è Service Worker non supportato dal browser');
        }
        
        // Verifica installazione PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± PWA installabile rilevata');
            e.preventDefault();
            window.deferredPrompt = e;
        });
        
        // ‚úÖ FUNZIONI PER IL PANNELLO ANALYTICS
        function refreshAnalyticsDashboard() {
            if (window.Analytics) {
                const summary = window.Analytics.getAnalyticsSummary();
                
                // Aggiorna statistiche
                document.getElementById('analytics-session-count').textContent = summary.sessions.today || '0';
                document.getElementById('analytics-events-count').textContent = summary.events.today || '0';
                document.getElementById('analytics-pageviews-count').textContent = summary.pageViews.today || '0';
                document.getElementById('analytics-errors-count').textContent = summary.errors.today || '0';
                
                // Aggiorna performance
                document.getElementById('metric-page-load').textContent = 
                    Math.round(summary.metrics.performance.average || 0) + 'ms';
                document.getElementById('metric-image-load').textContent = 
                    Math.round(summary.metrics.performance.imageLoad || 0) + 'ms';
                document.getElementById('metric-data-load').textContent = '0ms';
                
                // Aggiorna storage
                document.getElementById('storage-events').textContent = summary.events.total || '0';
                document.getElementById('storage-errors').textContent = summary.errors.total || '0';
                document.getElementById('storage-used').textContent = 
                    Math.round(summary.metrics.storage.eventsSize / 1024) + ' KB';
                
                // Aggiorna session info
                document.getElementById('current-session-id').textContent = 
                    summary.sessions.current.id.substring(0, 15) + '...';
                document.getElementById('current-user-id').textContent = 
                    summary.user.id.substring(0, 15) + '...';
                
                // Aggiorna sync info
                const lastSync = localStorage.getItem('analytics_last_sync');
                if (lastSync) {
                    const lastSyncDate = new Date(lastSync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastSyncDate) / (1000 * 60));
                    
                    if (diffMinutes < 1) {
                        document.getElementById('last-sync-time').textContent = 'Poco fa';
                    } else if (diffMinutes < 60) {
                        document.getElementById('last-sync-time').textContent = `${diffMinutes} minuti fa`;
                    } else {
                        document.getElementById('last-sync-time').textContent = 
                            lastSyncDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    }
                }
                
                // Aggiorna status
                const statusIndicator = document.getElementById('analytics-status-indicator');
                const statusText = document.getElementById('analytics-status-text');
                
                if (window.Analytics.config.trackingEnabled) {
                    statusIndicator.classList.remove('inactive');
                    statusIndicator.classList.add('active');
                    statusText.textContent = 'Analytics Attivo';
                    statusText.className = 'status-active';
                } else {
                    statusIndicator.classList.remove('active');
                    statusIndicator.classList.add('inactive');
                    statusText.textContent = 'Analytics Disattivo';
                    statusText.className = 'status-inactive';
                }
                
                // Aggiorna debug info
                document.getElementById('debug-initialized').textContent = window.Analytics.isInitialized ? 'Si' : 'No';
                document.getElementById('debug-firebase').textContent = window.firebaseAnalytics ? 'Si' : 'No';
                document.getElementById('debug-pwa').textContent = window.matchMedia('(display-mode: standalone)').matches ? 'Si' : 'No';
                document.getElementById('debug-online').textContent = navigator.onLine ? 'Si' : 'No';
                
                showToast('Dashboard analytics aggiornata', 'success');
                
                // Traccia l'evento
                window.Analytics.trackEvent('analytics', 'dashboard_refreshed');
            } else {
                showToast('Analytics non inizializzato', 'error');
            }
        }
        
        function exportAnalyticsData() {
            if (window.Analytics) {
                const filename = window.Analytics.exportAnalyticsData();
                showToast(`Dati analytics esportati in ${filename}`, 'success');
                window.Analytics.trackEvent('analytics', 'data_exported');
            } else {
                showToast('Analytics non inizializzato', 'error');
            }
        }
        
        function resetAnalyticsData() {
            if (confirm('Sei sicuro di voler resettare tutti i dati analytics? Questa azione non pu√≤ essere annullata.')) {
                if (window.Analytics) {
                    window.Analytics.resetUserData();
                    refreshAnalyticsDashboard();
                    showToast('Dati analytics resettati', 'success');
                    window.Analytics.trackEvent('analytics', 'data_reset');
                }
            }
        }
        
        function toggleAnalyticsTracking() {
            if (window.Analytics) {
                const newState = !window.Analytics.config.trackingEnabled;
                window.Analytics.setTrackingEnabled(newState);
                
                const btn = document.querySelector('[onclick="toggleAnalyticsTracking()"]');
                if (newState) {
                    btn.innerHTML = '<i class="fas fa-toggle-on"></i> Attiva/Disattiva';
                    btn.classList.add('primary');
                    btn.classList.remove('secondary');
                } else {
                    btn.innerHTML = '<i class="fas fa-toggle-off"></i> Attiva/Disattiva';
                    btn.classList.add('secondary');
                    btn.classList.remove('primary');
                }
                
                showToast(`Analytics ${newState ? 'attivato' : 'disattivato'}`, 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        function toggleAnalytics(enabled) {
            if (window.Analytics) {
                window.Analytics.setTrackingEnabled(enabled);
                showToast(`Tracciamento analytics ${enabled ? 'attivato' : 'disattivato'}`, 'success');
                refreshAnalyticsDashboard();
            }
        }
        
        function forceSyncAnalytics() {
            if (window.Analytics && window.Analytics.flushQueue) {
                window.Analytics.flushQueue(true);
                localStorage.setItem('analytics_last_sync', new Date().toISOString());
                refreshAnalyticsDashboard();
                showToast('Sync analytics forzato', 'info');
                window.Analytics.trackEvent('analytics', 'force_sync');
            }
        }
        
        function clearAnalyticsErrors() {
            if (confirm('Cancellare tutti gli errori registrati?')) {
                localStorage.removeItem('analytics_errors');
                refreshAnalyticsDashboard();
                showToast('Errori cancellati', 'success');
                if (window.Analytics) {
                    window.Analytics.trackEvent('analytics', 'errors_cleared');
                }
            }
        }
        
        function testAnalyticsEvent() {
            if (window.Analytics) {
                window.Analytics.trackEvent('test', 'manual_event', 'Test manuale', 1, {
                    test_mode: true,
                    timestamp: new Date().toISOString()
                });
                showToast('Evento test registrato', 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        function testAnalyticsError() {
            if (window.Analytics) {
                const testError = new Error('Errore di test manuale');
                testError.name = 'TestError';
                testError.code = 'TEST_001';
                
                window.Analytics.trackError(testError, 'test_manual', 'low', {
                    test_mode: true
                });
                showToast('Errore test registrato', 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        function testPerformanceMetric() {
            if (window.Analytics) {
                const loadTime = Math.random() * 1000 + 500;
                window.Analytics.trackPerformance('test_manual_load', loadTime);
                showToast(`Metrica test: ${Math.round(loadTime)}ms`, 'info');
                refreshAnalyticsDashboard();
            }
        }
        
        // Aggiorna automaticamente la dashboard quando si apre il tab
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                if (tabId === 'analytics-admin') {
                    setTimeout(() => {
                        refreshAnalyticsDashboard();
                        // Crea grafico se necessario
                        setTimeout(createActivityChart, 500);
                    }, 100);
                }
            });
        });
        
        function createActivityChart() {
            const canvas = document.getElementById('activity-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            
            // Se il grafico esiste gi√†, distruggilo
            if (window.activityChart) {
                window.activityChart.destroy();
            }
            
            // Dati di esempio per il grafico
            const labels = [];
            const data = [];
            
            // Genera dati per ultimi 7 giorni
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('it-IT', { weekday: 'short' }));
                
                // Valore casuale per demo
                data.push(Math.floor(Math.random() * 50) + 20);
            }
            
            // Crea grafico
            window.activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventi',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                stepSize: 10
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Inizializzazione quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', function() {
            // Carica analytics dashboard dopo un po'
            setTimeout(() => {
                if (window.Analytics) {
                    refreshAnalyticsDashboard();
                }
            }, 2000);
        });
    </script>
</body>
</html>